from flask import Flask, request, jsonify
from PIL import Image
from ultralytics import YOLO

app = Flask(__name__)

# โหลดโมเดล YOLO (เช่น yolov8 หรือที่ใหม่กว่า)
model = YOLO('yolo11x.pt')  # โหลดโมเดลจากไฟล์

@app.route('/detect', methods=['POST'])
def detect():
    if 'file' not in request.files:
        return jsonify({'error': 'No file part'}), 400
    file = request.files['file']
    if file.filename == '':
        return jsonify({'error': 'No selected file'}), 400

    img = Image.open(file.stream).convert('RGB')
    
    # รันโมเดลเพื่อทำการตรวจจับ
    results = model(img)
    
    # ดึงข้อมูล bounding boxes และ class
    detections = results[0].boxes  # ใช้ .boxes สำหรับ YOLO ใหม่
    if len(detections) > 0:
        output = []
        for box in detections:
            class_id = int(box.cls)  # ดึง class ID
            confidence = float(box.conf)  # ดึงความมั่นใจ
            label = model.names[class_id]  # ชื่อคลาสจาก ID
            output.append({
                'label': label,
                'confidence': confidence,
                'box': box.xywh.tolist()  # พิกัด xywh
            })
        return jsonify({'detections': output}), 200
    else:
        return jsonify({'message': 'ไม่พบวัตถุใดๆ ในภาพ'}), 200

if __name__ == '__main__':
    app.run(debug=True)
